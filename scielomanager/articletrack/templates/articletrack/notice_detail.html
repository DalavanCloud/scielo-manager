{% extends "base_list_lv0.html" %}
{% load i18n %}
{% load static %}
{% load trans_status %}
{% load scielo_common %}

{% block page_title %}{% trans "List of Notice" %}{% endblock %}

{% block content %}


<div class="row-fluid show-grid">
  <div class="span10">
    <h2>{% trans "Notices" %}:</h2>
    <h4>
      {% trans 'List of notices to' %}:
      <span class="muted">{{ checkin.package_name }}</span>
    </h4>
    <h4>
      {% trans 'Uploaded at' %}:
      <span class="muted">{{ checkin.created_at|date:"d/m/Y - H:i" }}</span>
    </h4>
  </div>
  <div class="2" style="text-align:right; margin-bottom:20px;">
    {% simple_pagination notices %}
  </div>
</div>

{% if perms.ticket.can_add %}

  <div class="row">
    <div class="span12">
      <a class='btn btn-mini btn-success pull-right' href="{% url ticket_add checkin.pk %}">
        {% trans "Create a ticket" %}
      </a>
    </div>
  </div>

{% endif %}

<table class="table">
  <thead>
    <tr>
      <th>{% trans "Stage" %}</th>
      <th>{% trans "Status" %}</th>
      <th>{% trans "Message" %}</th>
      <th>{% trans "Created_at" %}</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for notice in notices.object_list %}
    <tr class="{% trans_status notice.status %}">
      <td>
        {{ notice.stage }}
      </td>
      <td>
        {{ notice.status }}
      </td>
      <td>
        {{ notice.message }}
      </td>
      <td>
        {{ notice.created_at|date:"d/m/Y - H:i" }}
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="5">{% trans 'There are no items.' %}</td>
    </tr>
    {% endfor %}
  <tbody>
</table>

<div class="row-fluid show-grid">
  <div class="span12">
    <h2>{% trans "Related tickets" %}:</h2>
    <div class="tabbable"> <!-- Only required for left/right tabs -->
      <ul class="nav nav-tabs">
        <li class="active">
          <a href="#opened" data-toggle="tab">
            {% trans "Open" %} <span class="badge">{{ opened_tickets|length }}</span>
          </a>
        </li>
        <li>
          <a href="#closed" data-toggle="tab">
            {% trans "Closed" %} <span class="badge">{{ closed_tickets|length }}</span>
          </a>
        </li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane active" id="opened">
          {% with opened_tickets as tickets %}
            {% include "articletrack/includes/tickets_list_simple.html" %}
          {% endwith %}
        </div>
        <div class="tab-pane" id="closed">
          {% with closed_tickets as tickets %}
            {% include "articletrack/includes/tickets_list_simple.html" %}
          {% endwith %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="row-fluid show-grid">
  <div class="span12">
    <h2>{% trans 'Files' %}:</h2>
  </div>
</div>

<table id='files_table' class="table table-striped table-condensed">
  <thead>
    <tr>
      <th>{% trans "Type" %}</th>
      <th>{% trans "File" %}</th>
      <th>
        <div class="btn-group">
          <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
            {% trans "Select" %}
            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu">
            <li><a id='files_select_all' href="#"><i class="icon-ok"></i> {% trans "All" %}</a></li>
            <li><a id='files_select_none' href="#"><i class="icon-remove"></i> {% trans "None" %}</a></li>
          </ul>
        </div>

      </th>
    </tr>
  </thead>
  <tbody>
    {% for file in files %}
      <tr>
        <td>
          {% if file.ext == 'xml' %}
            <img src="{% static 'img/icon_xml.png' %}" alt='xml'> 
          {% elif file.ext == 'pdf' %}
            <img src="{% static 'img/icon_pdf.png' %}" alt='pdf'> 
          {% elif  file.ext == 'tif' %}
            <img src="{% static 'img/icon_img.png' %}" alt='tif'>
          {% else %}
            <img src="{{ STATIC_URL }}img/icon_other.png" alt='{% trans "other" %}'>
          {% endif %}
        </td>
        <td>{{ file.name }}</td>
        <td><input type='checkbox' data-filename='{{ file.name }}' name='file_select'></td>
      </tr>
      {% if forloop.last %}
        <tr>
          <td colspan='2'>
            <div id='file_download_msg' class="alert alert-info" style='display:none;'></div>
          </td>
          <td>
            <input id='files_download' type='button' class='btn btn-success' value='{% trans "Download" %}'>
          </td>
        </tr> 
      {% endif %}
    {% empty %}
      <tr>
        <td colspan='3'>
         <div id='file_download_msg'>
            <div class="alert alert-info">
              {% trans 'There are no files.' %}
            </div>
          </div>
        </td>
      </tr>
    {% endfor %}
  <tbody>
</table>

<!-- NAVIGATIONS -->
<div class="row-fluid show-grid">
  <div class="span12">
    <div class="btn-group">
      <a class="btn disabled">{% trans 'Go to' %}:</a>
      <a class="btn" href="{% url checkin_index %}"><i class="icon-arrow-left"></i> {% trans "List of check ins" %}</a>
      <a class="btn" href="{% url checkin_history checkin.article.pk %}"><i class="icon-time"></i> {% trans "Package history" %}</a>
      <a class="btn" href="{% url ticket_list %}"><i class="icon-exclamation-sign"></i> {% trans "List of Tickets" %}</a>
    </div>
  </div>
</div>

{% endblock %}

{% block extrafooter %}
  <script type="text/javascript">
    $(document).ready(function(){
      var fail_msg = '<i class="icon-warning-sign"></i> {% trans "Unable to communicate with the file server. Please try again later." %}';
      $.get('{% url get_balaio_api_is_up %}')
        .done(function( data ) {
          if (!data.is_up) {
            $('#file_download_msg').addClass('alert alert-error').html(fail_msg);
          }
        })
        .fail(function() {
          $('#file_download_msg').addClass('alert alert-error').html(fail_msg);
      });
      
      /* click files select All */
      $('#files_select_all').click(function(event){
        event.preventDefault();
        $('#file_download_msg').text('').hide();
        $('#files_table').find('input[type="checkbox"]').attr('checked', true);
      });
      
      /* click files select None */
      $('#files_select_none').click(function(event){
        event.preventDefault();
        $('#file_download_msg').text('').hide();
        $('#files_table').find('input[type="checkbox"]').attr('checked', false);
      });
      
      /* click files Download */
      $('#files_download').click(function(event){
        event.preventDefault();
        $('#file_download_msg').text('').hide();
        var selected = $('#files_table').find('input[type="checkbox"]:checked');
        var checkboxes = $('#files_table').find('input[type="checkbox"]');
        
        if (selected.length <= 0) {
        
          $('#file_download_msg').text('{% trans "Select any file to download" %}').show();
        
        } else {

          if (checkboxes.length == selected.length ) {
          
            /* download ALL files */
            window.location.href = '{% url get_balaio_api_full_package checkin.attempt_ref zip_filename %}';
            $('#file_download_msg').text('{% trans "Download will start right now" %}').show();
          
          } else {
          
            /* download SOME files */
            var qstring = selected.map(function(){ 
              return $(this).data('filename') 
            }).get().join('&file=');
            qstring = encodeURI("?file=" + qstring);

            var url = '{% url get_balaio_api_files_members checkin.attempt_ref zip_filename %}';
            window.location.href = url + qstring;
            $('#file_download_msg').text('{% trans "Download will start right now" %}').show();

          }

        }
      });
    });
  </script>
{% endblock %}